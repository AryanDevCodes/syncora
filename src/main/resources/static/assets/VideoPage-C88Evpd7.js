import{r as n,n as _,j as e,d as q}from"./index-C6EvfBZN.js";import{A as $}from"./AgoraRTC_N-production-DoeOQcPm.js";const K={mode:"rtc",codec:"vp8"},Q=s=>{const[u,w]=n.useState(!1),[l,x]=n.useState("DISCONNECTED"),[C,i]=n.useState([]),[b,v]=n.useState(null),a=n.useRef(null),m=n.useRef({...K,...s}),y=l==="CONNECTED",L=l==="CONNECTING",T=l==="DISCONNECTED",V=l==="RECONNECTING";n.useEffect(()=>{},[s]);const A=n.useCallback(async()=>{if(a.current)return console.warn("Agora client already initialized"),a.current;try{console.log("Initializing Agora RTC client with config:",m.current);const t=$.createClient({mode:m.current.mode||"rtc",codec:m.current.codec||"vp8"});if(!t)throw new Error("Failed to create Agora RTC client");const o=c=>{console.log("Agora connection state changed:",c),x(c)};return t.on("connection-state-change",o),t.on("user-joined",c=>{console.log("User joined:",c.uid),i(p=>[...p,c])}),t.on("user-left",c=>{console.log("User left:",c.uid),i(p=>p.filter(E=>E.uid!==c.uid))}),a.current=t,w(!0),console.log("Agora RTC client initialized successfully"),t}catch(t){const o=t instanceof Error?t:new Error(String(t));return console.error("Failed to initialize Agora client:",o),v(o),null}},[]),I=n.useCallback(async t=>{if(!a.current&&!await A())throw new Error("Failed to initialize Agora client");try{console.log("Joining channel:",t.channel),await a.current.join(t.appId,t.channel,t.token||null,t.uid),console.log("Successfully joined channel:",t.channel)}catch(o){const c=o instanceof Error?o:new Error(String(o));throw console.error("Failed to join channel:",c),v(c),c}},[A]),d=n.useCallback(async()=>{if(a.current)try{console.log("Leaving channel..."),await a.current.leave(),i([]),console.log("Successfully left channel")}catch(t){throw console.error("Failed to leave channel:",t),t}},[]),h=n.useCallback(async t=>{if(!a.current)throw new Error("Agora client not initialized");try{console.log("Publishing tracks..."),await a.current.publish(t),console.log("Successfully published tracks")}catch(o){throw console.error("Failed to publish tracks:",o),o}},[]),R=n.useCallback(async t=>{if(a.current)try{console.log("Unpublishing tracks..."),await Promise.all(t.map(o=>a.current.unpublish(o).catch(console.error))),console.log("Successfully unpublished tracks")}catch(o){throw console.error("Failed to unpublish tracks:",o),o}},[]),U=n.useCallback(async t=>{if(!a.current)throw new Error("Agora client not initialized");try{console.log("Renewing token..."),await a.current.renewToken(t),console.log("Successfully renewed token")}catch(o){throw console.error("Failed to renew token:",o),o}},[]),F=n.useCallback((t,o)=>{if(!a.current)throw new Error("Agora client not initialized");try{console.log(`Setting stream fallback option for user ${t} to ${o}`),a.current.setStreamFallbackOption(t,o)}catch(c){throw console.error("Failed to set stream fallback option:",c),c}},[]),M=n.useCallback(async()=>{if(!a.current)throw new Error("Agora client not initialized");try{console.log("Enabling dual stream..."),await a.current.enableDualStream(),console.log("Successfully enabled dual stream")}catch(t){throw console.error("Failed to enable dual stream:",t),t}},[]),S=n.useCallback(t=>{if(!a.current)throw new Error("Agora client not initialized");try{console.log("Setting low stream parameter:",t),a.current.setLowStreamParameter(t)}catch(o){throw console.error("Failed to set low stream parameter:",o),o}},[]);return n.useEffect(()=>{try{console.log("Initializing Agora client...");const t=$.createClient({mode:"rtc",codec:"vp8"}),o=f=>{console.log("Agora connection state changed:",f),x(f)};t.on("connection-state-change",o),t.on("user-published",async(f,z)=>{await t.subscribe(f,z),i(N=>[...N,f])}),t.on("user-unpublished",f=>{i(z=>z.filter(N=>N.uid!==f.uid))}),a.current=t,w(!0),console.log("Agora client initialized successfully");const c=f=>{console.log("Agora connection state changed:",f),x(f)},p=async(f,z)=>{await t.subscribe(f,z),i(N=>[...N,f])},E=f=>{i(z=>z.filter(N=>N.uid!==f.uid))};return t.on("connection-state-change",c),t.on("user-published",p),t.on("user-unpublished",E),()=>{console.log("Cleaning up Agora client..."),t&&(t.off("connection-state-change",c),t.off("user-published",p),t.off("user-unpublished",E),t.removeAllListeners(),t.connectionState==="CONNECTED"&&t.leave().catch(console.error)),x("DISCONNECTED"),i([])}}catch(t){console.error("Failed to initialize Agora client:",t),v(t)}},[]),n.useMemo(()=>({client:a.current,isInitialized:u,isConnected:y,isConnecting:L,isDisconnected:T,isReconnecting:V,connectionState:l,remoteUsers:C,error:b,initialize:A,join:I,leave:d,publish:h,unpublish:R,renewToken:U,setStreamFallbackOption:F,enableDualStream:M,setLowStreamParameter:S}),[u,y,L,T,V,l,C,b,A,I,d,h,R,U,F,M,S])},X=s=>{const[u,w]=n.useState([]),l=n.useCallback(i=>u.some(b=>String(b.uid)===String(i)),[u]),x=n.useCallback(i=>u.find(b=>String(b.uid)===String(i)),[u]);n.useEffect(()=>{if(!s)return;const i=()=>{w(a=>{const m=s.remoteUsers;return m.length!==a.length||!m.every((y,L)=>{var T;return y.uid===((T=a[L])==null?void 0:T.uid)})?[...m]:a})},b=async(a,m)=>{try{await s.subscribe(a,m),i()}catch(y){console.error("Error subscribing to user:",y)}},v=a=>{w(m=>m.filter(y=>y.uid!==a.uid))};return i(),s.on("user-published",b),s.on("user-left",v),s.on("user-joined",i),s.on("user-unpublished",i),s.on("user-info-updated",i),()=>{s.off("user-published",b),s.off("user-left",v),s.off("user-joined",i),s.off("user-unpublished",i),s.off("user-info-updated",i)}},[s]);const C=[...u];return C.isUserPublished=l,C.getParticipant=x,C},Z="/video",ee=async(s,u)=>(await _.get(`${Z}/token/${s}?uid=${u}`)).data.data,te=({uid:s,isLocal:u=!1,isSpeaking:w=!1,hasVideo:l=!1,index:x=0})=>e.jsxs("div",{id:`${u?"local":"remote"}-player-${s}`,className:`relative rounded-2xl overflow-hidden bg-gray-900 ${u?"ring-2 ring-blue-500":w?"ring-2 ring-green-500":""}`,"data-index":x,children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-2 bg-gray-800 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),e.jsx("span",{className:"text-sm font-light text-gray-400",children:u?"You":`User ${s}`})]})}),e.jsx("div",{className:"w-full h-full"}),!u&&e.jsx("div",{className:"absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-xs text-white",children:s})]}),le=({roomId:s,userEmail:u,onEnd:w=()=>{}})=>{var N,B,O;const[l,x]=n.useState([null,null]),[C,i]=n.useState(!1),[b,v]=n.useState(null),[a,m]=n.useState(!0),[y,L]=n.useState(new Set),[T,V]=n.useState(0),A=n.useRef(null),I=n.useRef(),{user:d}=q(),{client:h,isInitialized:R,isConnected:U,connectionState:F,error:M}=Q(),S=X(h),t=r=>{const g=Math.floor(r/3600),k=Math.floor(r%3600/60),j=r%60;return g>0?`${g}:${k.toString().padStart(2,"0")}:${j.toString().padStart(2,"0")}`:`${k.toString().padStart(2,"0")}:${j.toString().padStart(2,"0")}`},o=n.useCallback(r=>{const g=new Set;r.forEach(k=>{k.level>.1&&g.add(k.uid)}),L(g)},[]),c=n.useCallback(async()=>{if(!h||!R){console.log("Waiting for Agora client to initialize...");return}let r=null,g=null;try{m(!0),v(null);const k=await Promise.all([$.createMicrophoneAudioTrack().catch(P=>(console.warn("Microphone access error:",P),null)),$.createCameraVideoTrack({encoderConfig:{width:1280,height:720,frameRate:30,bitrateMax:1800,bitrateMin:1e3}}).catch(P=>(console.warn("Camera access error:",P),null))]);r=k[0],g=k[1],x([r,g]),g&&A.current&&g.play(A.current);const j=d!=null&&d.id?String(d.id):u.split("@")[0],{appId:D,rtcToken:W,channelName:G,uid:J}=await ee(s,j),Y=J??(d!=null&&d.id?String(d.id):void 0);await h.join(D,G,W,Y);const H=[r,g].filter(Boolean);H.length>0&&await h.publish(H),h.enableAudioVolumeIndicator(),h.on("volume-indicator",o),i(!0),I.current=setInterval(()=>{V(P=>P+1)},1e3)}catch(k){console.error("Error initializing call:",k),v("Failed to initialize video call. Please check your connection and try again."),[r,g].forEach(j=>{try{j==null||j.stop(),j==null||j.close()}catch(D){console.warn("Error cleaning up track after failure:",D)}}),x([null,null])}finally{m(!1)}},[h,R,s,d==null?void 0:d.id,u,o]),p=n.useCallback(async()=>{if(!h){console.warn("Client not initialized");return}try{if(I.current&&clearInterval(I.current),l.forEach(r=>{try{r==null||r.stop(),r==null||r.close()}catch(g){console.error("Error stopping track:",g)}}),h.connectionState==="CONNECTED")try{const r=l.filter(Boolean);r.length>0&&await h.unpublish(r),h.off("volume-indicator",o),await h.leave()}catch(r){console.error("Error during unpublish/leave:",r)}x([null,null]),i(!1),V(0),w()}catch(r){console.error("Error leaving call:",r),v("Failed to leave the call. Please try again.")}},[h,l,w,o]),E=n.useRef(p);n.useEffect(()=>{E.current=p},[p]);const f=n.useCallback(async()=>{const[r]=l;if(r)try{await r.setEnabled(!r.enabled)}catch(g){console.error("Error toggling microphone:",g)}},[l]),z=n.useCallback(async()=>{const[,r]=l;if(r)try{await r.setEnabled(!r.enabled)}catch(g){console.error("Error toggling camera:",g)}},[l]);return n.useEffect(()=>{!h||!R||C||(console.log("Agora client ready, initializing call..."),c())},[h,R,C,c]),n.useEffect(()=>{M&&(console.error("Agora client error:",M),v(`Connection error: ${M.message}`))},[M]),n.useEffect(()=>()=>{var r;(r=E.current)==null||r.call(E)},[]),b?e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-black text-white",children:e.jsxs("div",{className:"text-center max-w-md mx-auto px-6",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-6 bg-red-500/10 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-10 h-10 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsx("h2",{className:"text-2xl font-light mb-3",children:b}),e.jsx("p",{className:"text-gray-400 mb-8 text-sm",children:"Please check your connection and try again"}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx("button",{onClick:c,className:"px-8 py-3 bg-white text-black rounded-full font-medium hover:bg-gray-200 transition-colors",children:"Retry"}),e.jsx("button",{onClick:p,className:"px-8 py-3 bg-gray-800 text-white rounded-full font-medium hover:bg-gray-700 transition-colors",children:"Leave"})]})]})}):e.jsxs("div",{className:"flex flex-col w-full h-screen bg-black text-white",children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 z-10 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${C?"bg-green-500":"bg-yellow-500"}`}),e.jsx("span",{className:"text-sm font-light text-gray-300",children:t(T)})]})}),e.jsxs("div",{className:"text-sm font-light text-gray-400",children:[S.length+1," ",S.length===0?"person":"people"]})]})}),e.jsx("div",{className:"flex-1 p-6 overflow-hidden",children:e.jsxs("div",{className:`h-full grid gap-4 ${S.length===0?"grid-cols-1":S.length===1?"grid-cols-2":S.length===2?"grid-cols-3":"grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"}`,children:[e.jsxs("div",{className:"relative rounded-3xl bg-gray-900 overflow-hidden group",children:[e.jsx("div",{ref:A,className:"w-full h-full flex items-center justify-center",children:(!l[1]||!l[1].enabled)&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-3 bg-gray-800 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),e.jsx("p",{className:"text-gray-500 text-sm font-light",children:"Camera off"})]})}),e.jsxs("div",{className:"absolute bottom-4 left-4 right-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-light",children:[(d==null?void 0:d.name)||u.split("@")[0]," (You)"]}),y.has(((N=d==null?void 0:d.id)==null?void 0:N.toString())||"local")&&e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex gap-1",children:[l[0]&&!l[0].enabled&&e.jsx("div",{className:"w-7 h-7 bg-red-500/90 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z",clipRule:"evenodd"})})}),l[1]&&!l[1].enabled&&e.jsx("div",{className:"w-7 h-7 bg-red-500/90 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A2 2 0 0018 13V7a2 2 0 00-2.828-1.828L13 6.586V5a2 2 0 00-2-2H6.828L3.707 2.293z",clipRule:"evenodd"})})})]})]})]}),S.map(r=>e.jsx(te,{uid:String(r.uid),isLocal:!1,isSpeaking:y.has(r.uid),hasVideo:!!r.videoTrack,videoTrack:r.videoTrack,audioTrack:r.audioTrack},String(r.uid)))]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 z-10 p-8",children:e.jsxs("div",{className:"max-w-md mx-auto flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:f,className:`w-14 h-14 rounded-full transition-all ${l[0]&&l[0].enabled?"bg-gray-800/80 hover:bg-gray-700/80 backdrop-blur-xl":"bg-red-500 hover:bg-red-600"}`,title:(B=l[0])!=null&&B.enabled?"Mute":"Unmute",children:e.jsx("svg",{className:"w-6 h-6 mx-auto",fill:"currentColor",viewBox:"0 0 20 20",children:l[0]&&l[0].enabled?e.jsx("path",{fillRule:"evenodd",d:"M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z",clipRule:"evenodd"}):e.jsx("path",{fillRule:"evenodd",d:"M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z",clipRule:"evenodd"})})}),e.jsx("button",{onClick:z,className:`w-14 h-14 rounded-full transition-all ${l[1]&&l[1].enabled?"bg-gray-800/80 hover:bg-gray-700/80 backdrop-blur-xl":"bg-red-500 hover:bg-red-600"}`,title:(O=l[1])!=null&&O.enabled?"Stop Video":"Start Video",children:e.jsx("svg",{className:"w-6 h-6 mx-auto",fill:"currentColor",viewBox:"0 0 20 20",children:l[1]&&l[1].enabled?e.jsx("path",{d:"M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"}):e.jsx("path",{fillRule:"evenodd",d:"M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A2 2 0 0018 13V7a2 2 0 00-2.828-1.828L13 6.586V5a2 2 0 00-2-2H6.828L3.707 2.293zM13 11.586l-3-3V5h3v6.586zM5 5.414L7.414 7.83 5 10.243V5.414z",clipRule:"evenodd"})})}),e.jsx("button",{onClick:p,className:"w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 transition-all",title:"End Call",children:e.jsx("svg",{className:"w-6 h-6 mx-auto",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"})})})]})})]})};export{le as default};
